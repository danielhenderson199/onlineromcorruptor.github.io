<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>MIDI Distorter + Generator</title>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi/build/Tone.Midi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tone/build/Tone.min.js"></script>
<style>
  body { background: #121212; color: #0f0; font-family: monospace; padding: 15px; }
  label { display: block; margin-top: 10px; }
  input[type=range] { width: 300px; }
  button { margin-top: 15px; background: #0f0; border: none; padding: 8px 15px; color: #000; font-weight: bold; cursor: pointer; border-radius: 5px; }
  #log { margin-top: 15px; max-height: 100px; overflow-y: auto; font-size: 14px; }
</style>
</head>
<body>

<h1>MIDI Distorter & Generator</h1>

<label>Загрузить MIDI файл:
  <input type="file" id="midi-file" accept=".mid,.midi" />
</label>

<label>Изменить питч (полутонов): <span id="pitch-val">0</span>
  <input type="range" id="pitch" min="-12" max="12" value="0" />
</label>

<label>Вероятность добавления случайной ноты (%): <span id="prob-gen-val">10</span>
  <input type="range" id="prob-gen" min="0" max="100" value="10" />
</label>

<label>Вероятность искажения ноты (%): <span id="prob-distort-val">10</span>
  <input type="range" id="prob-distort" min="0" max="100" value="10" />
</label>

<label>Добавлять случайную перкуссию (барабаны):
  <input type="checkbox" id="add-percussion" checked />
</label>

<button id="process-btn" disabled>Искажать и играть</button>
<button id="download-btn" disabled>Скачать изменённый MIDI</button>

<div id="log"></div>

<script>
  let originalMidi = null;
  let distortedMidi = null;

  const midiFileInput = document.getElementById('midi-file');
  const pitchSlider = document.getElementById('pitch');
  const probGenSlider = document.getElementById('prob-gen');
  const probDistortSlider = document.getElementById('prob-distort');
  const addPercussionCheckbox = document.getElementById('add-percussion');
  const processBtn = document.getElementById('process-btn');
  const downloadBtn = document.getElementById('download-btn');
  const logDiv = document.getElementById('log');

  function log(msg) {
    logDiv.textContent = msg;
  }

  midiFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const arrayBuffer = await file.arrayBuffer();
    originalMidi = new Midi(arrayBuffer);
    distortedMidi = null;
    log(`Загружен MIDI: ${file.name}, треков: ${originalMidi.tracks.length}`);
    processBtn.disabled = false;
    downloadBtn.disabled = true;
  });

  function randomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function distortMidi(midi, pitchShift, probGen, probDistort, addPercussion) {
    const newMidi = new Midi();
    newMidi.header = midi.header;

    // Копируем и искажаем треки
    midi.tracks.forEach((track, trackIdx) => {
      const newTrack = newMidi.addTrack();

      track.notes.forEach(note => {
        let newNote = {...note};

        // Случайная генерация новых нот
        if (Math.random() * 100 < probGen) {
          const randMidi = randomInt(48, 84); // Диапазон C3-B5
          newTrack.addNote({
            midi: randMidi,
            time: note.time + Math.random() * 0.5,
            duration: note.duration,
            velocity: Math.min(1, note.velocity + Math.random() * 0.5)
          });
        }

        // Искажение нот с вероятностью
        if (Math.random() * 100 < probDistort) {
          newNote.midi += pitchShift;
          if (newNote.midi < 0) newNote.midi = 0;
          if (newNote.midi > 127) newNote.midi = 127;
        }

        newTrack.addNote(newNote);
      });
    });

    // Добавляем перкуссию как отдельный трек
    if (addPercussion) {
      const percTrack = newMidi.addTrack();
      percTrack.channel = 9; // Канал 10 - перкуссия
      // Добавим случайные удары
      for (let t = 0; t < 30; t += 0.25) {
        if (Math.random() < 0.1) {
          const drumNote = randomInt(35, 81); // диапазон барабанов
          percTrack.addNote({
            midi: drumNote,
            time: t,
            duration: 0.1,
            velocity: 0.8
          });
        }
      }
    }

    return newMidi;
  }

  async function playMidi(midi) {
    await Tone.start();
    Tone.Transport.cancel();
    Tone.Transport.stop();

    // Чистим старые синтезаторы
    if (window.synth) {
      window.synth.dispose();
    }
    window.synth = new Tone.PolySynth(Tone.Synth).toDestination();

    // Создаем последовательность из нот
    midi.tracks.forEach(track => {
      track.notes.forEach(note => {
        const now = Tone.now();
        window.synth.triggerAttackRelease(
          Tone.Frequency(note.midi, "midi"),
          note.duration,
          now + note.time,
          note.velocity
        );
      });
    });

    Tone.Transport.start();
  }

  processBtn.addEventListener('click', () => {
    if (!originalMidi) return;
    const pitchShift = parseInt(pitchSlider.value);
    const probGen = parseInt(probGenSlider.value);
    const probDistort = parseInt(probDistortSlider.value);
    const addPercussion = addPercussionCheckbox.checked;

    distortedMidi = distortMidi(originalMidi, pitchShift, probGen, probDistort, addPercussion);
    log("MIDI искажен, проигрываем...");

    playMidi(distortedMidi).catch(e => {
      log("Ошибка воспроизведения: " + e.message);
    });

    downloadBtn.disabled = false;
  });

  downloadBtn.addEventListener('click', () => {
    if (!distortedMidi) return;
    const bytes = distortedMidi.toArray();
    const blob = new Blob([bytes], {type: "audio/midi"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "distorted.mid";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Обновление подписей к слайдерам
  pitchSlider.addEventListener('input', () => {
    document.getElementById('pitch-val').textContent = pitchSlider.value;
  });
  probGenSlider.addEventListener('input', () => {
    document.getElementById('prob-gen-val').textContent = probGenSlider.value;
  });
  probDistortSlider.addEventListener('input', () => {
    document.getElementById('prob-distort-val').textContent = probDistortSlider.value;
  });
</script>

</body>
</html>
