<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Мульти-эмулятор с редактором памяти: NES + Sega</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 1rem;
      user-select: none;
    }
    #screen {
      image-rendering: pixelated;
      border: 2px solid #0f0;
      background: black;
      display: block;
      margin-bottom: 1rem;
    }
    #memory-editor {
      max-height: 300px;
      overflow-y: scroll;
      border: 2px solid #0f0;
      padding: 0.5rem;
      background: #222;
      margin-bottom: 1rem;
      width: 600px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    td, th {
      border: 1px solid #0f0;
      padding: 2px 4px;
      text-align: center;
      font-size: 12px;
    }
    th {
      background: #0f0;
      color: #000;
      cursor: pointer;
    }
    input[type="text"] {
      width: 40px;
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      text-align: center;
      font-family: monospace;
    }
    #controls-desc {
      max-width: 600px;
      margin-bottom: 1rem;
      border: 2px solid #0f0;
      padding: 0.5rem;
      background: #222;
    }
  </style>
</head>
<body>

<h1>Мульти-эмулятор с редактором памяти: NES + Sega</h1>

<label>Выбери систему:
  <select id="system-select">
    <option value="nes">NES / Dendy</option>
    <option value="sega">Sega Genesis / Mega Drive</option>
  </select>
</label>
<br/><br/>

<input type="file" id="rom-file" accept=".nes,.gen,.bin,.md" />
<button id="start-btn">Запустить ROM</button>
<br/><br/>

<canvas id="screen" width="256" height="240"></canvas>

<div id="memory-editor">
  <h3>RAM (Оперативная память)</h3>
  <table id="ram-table"></table>
</div>

<p id="status"></p>

<div id="controls-desc">
  <h3>Управление</h3>
  <ul id="controls-list">
    <!-- Наполняется динамически -->
  </ul>
</div>

<script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sega.js@0.0.8/dist/sega.min.js"></script>

<script>
  const screen = document.getElementById('screen');
  const ctx = screen.getContext('2d');
  const romFile = document.getElementById('rom-file');
  const startBtn = document.getElementById('start-btn');
  const ramTable = document.getElementById('ram-table');
  const status = document.getElementById('status');
  const systemSelect = document.getElementById('system-select');
  const controlsList = document.getElementById('controls-list');

  let nes = null;
  let sega = null;
  let frameId = null;
  let currentSystem = 'nes';
  let romData = null;

  // ----------------- Утилиты для вывода изображения -----------------

  function drawFrame(buffer, width=256, height=240) {
    const imageData = ctx.createImageData(width, height);
    for(let i = 0; i < buffer.length; i++) {
      const val = buffer[i];
      imageData.data[i*4+0] = (val >> 16) & 0xff;
      imageData.data[i*4+1] = (val >> 8) & 0xff;
      imageData.data[i*4+2] = val & 0xff;
      imageData.data[i*4+3] = 0xff;
    }
    ctx.putImageData(imageData, 0, 0);
  }

  // ----------------- NES -----------------
  function setupNES(rom) {
    if(nes) {
      cancelAnimationFrame(frameId);
      nes = null;
    }
    nes = new jsnes.NES({
      onFrame: function(buffer) {
        drawFrame(buffer);
      },
      onAudioSample: function(left, right) {
        // Можно добавить звук, если нужно
      }
    });
    nes.loadROM(rom);
    status.textContent = 'NES загружен.';
    runNES();
    renderControls('nes');
  }

  function runNES() {
    nes.frame();
    updateNESRAMTable();
    frameId = requestAnimationFrame(runNES);
  }

  function updateNESRAMTable() {
    // RAM CPU $0000-$07FF
    const ram = nes.cpu.mem;
    let html = '<tr><th>Addr</th>';
    for(let i=0;i<8;i++) html += `<th>+${i.toString(16).toUpperCase()}</th>`;
    html += '</tr>';
    for(let addr=0;addr<0x800;addr+=8) {
      html += `<tr><td>${addr.toString(16).padStart(4,'0').toUpperCase()}</td>`;
      for(let off=0;off<8;off++) {
        const val = ram[addr+off];
        html += `<td>${val.toString(16).padStart(2,'0').toUpperCase()}</td>`;
      }
      html += '</tr>';
    }
    ramTable.innerHTML = html;
  }

  // ----------------- Sega -----------------
  function setupSega(rom) {
    if(sega) {
      cancelAnimationFrame(frameId);
      sega = null;
    }
    // Sega.js API https://github.com/nomi9995/sega.js
    sega = new Sega({
      canvas: screen,
      onFrame: () => {
        // рисуем через canvas - sega.js уже сам рисует
        // ничего делать не надо
      }
    });
    sega.loadROM(rom);
    status.textContent = 'Sega Genesis загружен.';
    runSega();
    renderControls('sega');
  }

  function runSega() {
    sega.frame();
    updateSegaRAMTable();
    frameId = requestAnimationFrame(runSega);
  }

  function updateSegaRAMTable() {
    // В sega.js доступ к RAM сложнее, тут примерный вариант:
    // sega.memory.ram - Uint8Array 64KB
    if(!sega || !sega.memory || !sega.memory.ram) {
      ramTable.innerHTML = '<tr><td>RAM не доступна</td></tr>';
      return;
    }
    const ram = sega.memory.ram;
    let html = '<tr><th>Addr</th>';
    for(let i=0;i<8;i++) html += `<th>+${i.toString(16).toUpperCase()}</th>`;
    html += '</tr>';
    for(let addr=0;addr<0x4000;addr+=8) {
      html += `<tr><td>${addr.toString(16).padStart(4,'0').toUpperCase()}</td>`;
      for(let off=0;off<8;off++) {
        const val = ram[addr+off];
        html += `<td>${val.toString(16).padStart(2,'0').toUpperCase()}</td>`;
      }
      html += '</tr>';
    }
    ramTable.innerHTML = html;
  }

  // ----------------- Загрузка файла -----------------
  romFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      romData = new Uint8Array(reader.result);
      status.textContent = `ROM "${file.name}" загружен (${romData.length} байт)`;
    };
    reader.readAsArrayBuffer(file);
  });

  // ----------------- Запуск -----------------
  startBtn.onclick = () => {
    if(!romData) {
      alert('Выберите ROM файл');
      return;
    }
    currentSystem = systemSelect.value;
    if(currentSystem === 'nes') {
      setupNES(romData);
    } else if(currentSystem === 'sega') {
      setupSega(romData);
    }
  };

  // ----------------- Отображение управления -----------------
  function renderControls(system) {
    let html = '';
    if(system === 'nes') {
      html = `
        <li>Стрелки — движение (Up, Down, Left, Right)</li>
        <li>Z — Кнопка A</li>
        <li>X — Кнопка B</li>
        <li>Enter — Start</li>
        <li>Shift — Select</li>
      `;
    } else if(system === 'sega') {
      html = `
        <li>Стрелки — движение</li>
        <li>Z — Кнопка A</li>
        <li>X — Кнопка B</li>
        <li>A — Кнопка C</li>
        <li>Enter — Start</li>
      `;
    }
    controlsList.innerHTML = html;
  }

  // ----------------- Управление клавишами -----------------
  window.addEventListener('keydown', e => {
    if(currentSystem === 'nes' && nes) {
      switch(e.key) {
        case 'ArrowUp': nes.buttonDown(1, jsnes.Controller.BUTTON_UP); break;
        case 'ArrowDown': nes.buttonDown(1, jsnes.Controller.BUTTON_DOWN); break;
        case 'ArrowLeft': nes.buttonDown(1, jsnes.Controller.BUTTON_LEFT); break;
        case 'ArrowRight': nes.buttonDown(1, jsnes.Controller.BUTTON_RIGHT); break;
        case 'z': case 'Z': nes.buttonDown(1, jsnes.Controller.BUTTON_A); break;
        case 'x': case 'X': nes.buttonDown(1, jsnes.Controller.BUTTON_B); break;
        case 'Enter': nes.buttonDown(1, jsnes.Controller.BUTTON_START); break;
        case 'Shift': nes.buttonDown(1, jsnes.Controller.BUTTON_SELECT); break;
      }
    }
    if(currentSystem === 'sega' && sega) {
      switch(e.key) {
        case 'ArrowUp': sega.input.setKey('up', true); break;
        case 'ArrowDown': sega.input.setKey('down', true); break;
        case 'ArrowLeft': sega.input.setKey('left', true); break;
        case 'ArrowRight': sega.input.setKey('right', true); break;
        case 'z': case 'Z': sega.input.setKey('a', true); break;
        case 'x': case 'X': sega.input.setKey('b', true); break;
        case 'a': case 'A': sega.input.setKey('c', true); break;
        case 'Enter': sega.input.setKey('start', true); break;
      }
    }
  });

  window.addEventListener('keyup', e => {
    if(currentSystem === 'nes' && nes) {
      switch(e.key) {
        case 'ArrowUp': nes.buttonUp(1, jsnes.Controller.BUTTON_UP); break;
        case 'ArrowDown': nes.buttonUp(1, jsnes.Controller.BUTTON_DOWN); break;
        case 'ArrowLeft': nes.buttonUp(1, jsnes.Controller.BUTTON_LEFT); break;
        case 'ArrowRight': nes.buttonUp(1, jsnes.Controller.BUTTON_RIGHT); break;
        case 'z': case 'Z': nes.buttonUp(1, jsnes.Controller.BUTTON_A); break;
        case 'x': case 'X': nes.buttonUp(1, jsnes.Controller.BUTTON_B); break;
        case 'Enter': nes.buttonUp(1, jsnes.Controller.BUTTON_START); break;
        case 'Shift': nes.buttonUp(1, jsnes.Controller.BUTTON_SELECT); break;
      }
    }
    if(currentSystem === 'sega' && sega) {
      switch(e.key) {
        case 'ArrowUp': sega.input.setKey('up', false); break;
        case 'ArrowDown': sega.input.setKey('down', false); break;
        case 'ArrowLeft': sega.input.setKey('left', false); break;
        case 'ArrowRight': sega.input.setKey('right', false); break;
        case 'z': case 'Z': sega.input.setKey('a', false); break;
        case 'x': case 'X': sega.input.setKey('b', false); break;
        case 'a': case 'A': sega.input.setKey('c', false); break;
        case 'Enter': sega.input.setKey('start', false); break;
      }
    }
  });

</script>

</body>
</html>
