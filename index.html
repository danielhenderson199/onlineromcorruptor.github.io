<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>RT Corruptor + EmulatorJS</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      padding: 10px;
    }
    #rom-info {
      margin-bottom: 10px;
    }
    #memory-editor {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-width: 100vw;
      overflow-x: auto;
      max-height: 300px;
      border: 2px solid #0f0;
      padding: 10px;
      background: #222;
      margin-bottom: 15px;
    }
    .byte-block {
      width: 50px;
      background: #333;
      border: 1px solid #0f0;
      padding: 6px;
      user-select: none;
    }
    .addr {
      font-size: 10px;
      color: #080;
      margin-bottom: 4px;
      text-align: center;
    }
    .byte-value {
      font-size: 14px;
      margin-bottom: 4px;
      text-align: center;
      letter-spacing: 2px;
    }
    input[type=range] {
      width: 100%;
    }
    #checksum-toggle {
      margin-top: 15px;
      margin-bottom: 15px;
      user-select: none;
    }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      background: #0f0;
      border: none;
      cursor: pointer;
      font-weight: bold;
      color: #000;
      border-radius: 4px;
    }
    iframe {
      border: 2px solid #0f0;
      width: 100%;
      max-width: 640px;
      height: 360px;
      background: #000;
    }
  </style>
</head>
<body>

<h1>RT Corruptor + EmulatorJS</h1>

<input type="file" id="rom-file" accept=".bin,.nes,.gen,.md,.smd,.sms" />
<div id="rom-info"></div>

<label id="checksum-toggle">
  <input type="checkbox" id="checksum" checked />
  Включить чекcум (checksum)
</label>

<div id="memory-editor" style="display:none;"></div>

<button id="save-btn" style="display:none;">Скачать изменённый ROM</button>

<h2>Эмулятор</h2>
<iframe id="emulator-frame" src="" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>

<script>
  let romData = null;
  let currentRomBlobUrl = null;

  const romFile = document.getElementById('rom-file');
  const romInfo = document.getElementById('rom-info');
  const memoryEditor = document.getElementById('memory-editor');
  const saveBtn = document.getElementById('save-btn');
  const checksumToggle = document.getElementById('checksum');
  const emulatorFrame = document.getElementById('emulator-frame');

  romFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      romData = new Uint8Array(reader.result);
      romInfo.textContent = `Файл "${file.name}" загружен, размер: ${romData.length} байт.`;
      renderMemoryEditor();
      memoryEditor.style.display = 'flex';
      saveBtn.style.display = 'inline-block';

      loadEmulatorWithRom();
    };
    reader.readAsArrayBuffer(file);
  });

  function renderMemoryEditor() {
    memoryEditor.innerHTML = '';
    const maxBytesToShow = Math.min(128, romData.length); // ограничим, чтобы не тормозило
    for (let i = 0; i < maxBytesToShow; i++) {
      const byteBlock = document.createElement('div');
      byteBlock.className = 'byte-block';

      const addrDiv = document.createElement('div');
      addrDiv.className = 'addr';
      addrDiv.textContent = i.toString(16).padStart(4, '0').toUpperCase();
      byteBlock.appendChild(addrDiv);

      const valDiv = document.createElement('div');
      valDiv.className = 'byte-value';
      valDiv.textContent = romData[i].toString(16).padStart(2, '0').toUpperCase();
      byteBlock.appendChild(valDiv);

      const slider = document.createElement('input');
      slider.type = 'range';
      slider.min = 0;
      slider.max = 255;
      slider.value = romData[i];
      slider.addEventListener('input', () => {
        romData[i] = Number(slider.value);
        valDiv.textContent = Number(slider.value).toString(16).padStart(2, '0').toUpperCase();
        if (checksumToggle.checked) {
          // Здесь можно добавить логику по checksum
          byteBlock.style.borderColor = '#ff0';
        } else {
          byteBlock.style.borderColor = '#0f0';
        }
        // Перезагружаем эмулятор с обновлённым ROM
        loadEmulatorWithRom();
      });
      byteBlock.appendChild(slider);

      memoryEditor.appendChild(byteBlock);
    }
  }

  function loadEmulatorWithRom() {
    if (currentRomBlobUrl) {
      URL.revokeObjectURL(currentRomBlobUrl);
      currentRomBlobUrl = null;
    }
    const blob = new Blob([romData], { type: 'application/octet-stream' });
    currentRomBlobUrl = URL.createObjectURL(blob);

    // Формируем URL для demo.emulatorjs.org
    // Пример: https://demo.emulatorjs.org/?game=https://example.com/rom.bin
    const url = `https://demo.emulatorjs.org/?game=${encodeURIComponent(currentRomBlobUrl)}`;

    emulatorFrame.src = url;
  }

  saveBtn.addEventListener('click', () => {
    if (!romData) return;
    const blob = new Blob([romData], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modified_rom.bin';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
