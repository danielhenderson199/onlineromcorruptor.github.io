<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Danilabs ROM Glitcher + –≠–º—É–ª—è—Ç–æ—Ä</title>
  <script src="https://unpkg.com/jsnes@0.8.0/dist/jsnes.min.js"></script>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .container {
      background: #222;
      border: 2px solid #0f0;
      padding: 2rem;
      border-radius: 10px;
      max-width: 800px;
      width: 100%;
      text-align: center;
    }

    canvas {
      image-rendering: pixelated;
      margin-top: 1rem;
      border: 3px solid #0f0;
    }

    button, select, input[type="file"], input[type="range"] {
      margin: 0.7rem 0;
    }

    button {
      padding: 0.6rem 1.5rem;
      background: #0f0;
      border: none;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background: #5f5;
    }

    #romInfo {
      font-size: 0.9rem;
      margin-top: 1rem;
      background: #000;
      padding: 1rem;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÆ Danilabs ROM Glitcher + Emulator</h1>

    <input type="file" id="romFile" accept=".nes" />
    <br />
    <label>üéµ –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞: <input type="file" id="musicFile" accept="audio/*" /></label>
    <br /><br />

    <label for="glitchLevel">–£—Ä–æ–≤–µ–Ω—å –∏—Å–∫–∞–∂–µ–Ω–∏—è: <span id="glitchValue">10%</span></label><br>
    <input type="range" id="glitchLevel" min="0" max="100" value="10" />

    <br />
    <label for="glitchMode">–†–µ–∂–∏–º –∏—Å–∫–∞–∂–µ–Ω–∏—è:</label><br>
    <select id="glitchMode">
      <option value="random">üîÄ –°–ª—É—á–∞–π–Ω—ã–π</option>
      <option value="graphics">üé® –¢–æ–ª—å–∫–æ –≥—Ä–∞—Ñ–∏–∫–∞</option>
      <option value="logic">üß† –¢–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞</option>
      <option value="sound">üîá –¢–æ–ª—å–∫–æ –∑–≤—É–∫</option>
    </select>

    <br /><br />
    <button id="glitchButton">üéÆ –ò—Å–∫–∞–∂–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å</button>

    <p id="status"></p>
    <div id="romInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ROM –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>

    <canvas id="nes-canvas" width="256" height="240"></canvas>
  </div>

  <audio id="bgMusic" loop></audio>

  <script>
    const fileInput = document.getElementById('romFile');
    const glitchLevel = document.getElementById('glitchLevel');
    const glitchValue = document.getElementById('glitchValue');
    const glitchMode = document.getElementById('glitchMode');
    const button = document.getElementById('glitchButton');
    const status = document.getElementById('status');
    const romInfo = document.getElementById('romInfo');
    const musicFile = document.getElementById('musicFile');
    const audio = document.getElementById('bgMusic');

    glitchLevel.addEventListener('input', () => {
      glitchValue.textContent = glitchLevel.value + '%';
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      romInfo.innerHTML = `
        üì¶ –ò–º—è: <b>${file.name}</b><br>
        üìÅ –†–∞–∑–º–µ—Ä: <b>${file.size} –±–∞–π—Ç</b><br>
        üìÄ –§–æ—Ä–º–∞—Ç: <b>${file.name.split('.').pop().toUpperCase()}</b>
      `;
    });

    musicFile.addEventListener('change', () => {
      const file = musicFile.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        audio.src = url;
        audio.play();
      }
    });

    // jsNES –∏ Canvas
    const canvas = document.getElementById('nes-canvas');
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, 256, 240);

    const nes = new jsnes.NES({
      onFrame: function(frameBuffer) {
        for (let i = 0; i < frameBuffer.length; i++) {
          const color = frameBuffer[i];
          imageData.data[i * 4 + 0] = (color >> 16) & 0xFF;
          imageData.data[i * 4 + 1] = (color >> 8) & 0xFF;
          imageData.data[i * 4 + 2] = color & 0xFF;
          imageData.data[i * 4 + 3] = 0xFF;
        }
        ctx.putImageData(imageData, 0, 0);
      },
      onStatusUpdate: msg => console.log(msg),
      onAudioSample: () => {}
    });

    button.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ ROM-—Ñ–∞–π–ª!');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        let buffer = new Uint8Array(e.target.result);
        const glitchAmount = parseInt(glitchLevel.value);
        const mode = glitchMode.value;
        const safeZone = 16;
        const size = buffer.length;
        let start = safeZone, end = size;

        if (mode === 'graphics') {
          start = Math.floor(size * 0.5);
        } else if (mode === 'logic') {
          end = Math.floor(size * 0.5);
        } else if (mode === 'sound') {
          start = Math.floor(size * 0.75);
        }

        const changes = Math.floor((end - start) * glitchAmount / 100);
        for (let i = 0; i < changes; i++) {
          const index = Math.floor(Math.random() * (end - start)) + start;
          buffer[index] = Math.floor(Math.random() * 256);
        }

        status.textContent = `‚úÖ ROM –∏—Å–∫–∞–∂—ë–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º...`;

        // –ó–∞–ø—É—Å–∫ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
        nes.loadROM(bufferToBase64(buffer));
      };

      reader.readAsArrayBuffer(file);
    });

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ base64
    function bufferToBase64(buffer) {
      let binary = '';
      for (let i = 0; i < buffer.length; i++) {
        binary += String.fromCharCode(buffer[i]);
      }
      return btoa(binary);
    }
  </script>
</body>
</html>
